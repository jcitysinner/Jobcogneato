<!DOCTYPE HTML>
<html>
<head>
	<meta name="viewport" content="width=device-width, minimumscale=1.0, maximum-scale=1.0" />
	<title>Jobcogneato</title>
	<link rel="stylesheet" href="styles/main.css" type="text/css"/>
	<!-- JQuery -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

	<!-- Parse -->
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.0.min.js"></script>

	<!-- Sidr -->
	<link rel="stylesheet" href="src/jquery.sidr.dark.css">
	<script src="src/jquery.sidr.min.js"></script>

	<!-- LinkedIn -->
	<script type="text/javascript" src="http://platform.linkedin.com/in.js">
	   api_key: 773og0ol3lmrlw
	   authorize: true
	</script>
	
	
	

</head>
<body>

	<div id="sidr">
	  <!-- Your content -->
	  <ul>
	    <li><a href="#" onclick='onLinkedInAuth()'>Contacts</a></li>
	    <li><a href="#" onclick='toNotifications()'>Notifications</a></li>
	    <li><a href="#" onclick='toStatus()'>Status</a></li>
	     <li><a href="#" id='logout'>Logout</a></li>
	  </ul>
	</div>
	 
	<script>
		$(document).ready(function() {
		  $('#simple-menu').sidr({
		  	side: 'right'
		  });
		});
	</script>

	<div class="container">
		<nav>
	
			<a id="simple-menu" href="#sidr" style='float: right;'><img src='images/menu.svg'></a>
		</nav>
	</div>
	<div class='container' id='container'>
		
	</div>
	<script type="text/javascript">

		$("#container").load("login.html");

		//---------------------------------------- PARSE CODE ----------------------------------------
		Parse.initialize("5Wmcy8fD1tEb3xxEyl7nfnDblCGNGsV1r0gBzkve", "ogYIX99AVCaaFO698jxXM3Re67DF05FevHRzRzvw");

		var userId = '';
		var userObjectId = '';
		var innerCircleList = [];
		var trueCircleList = [];
		var iconsList = ['images/eye.png', 'images/ear.png', 'images/happy.png'];

	    //---------------------------------------- LinkedIn CODE ----------------------------------------
		function onLinkedInAuth() {
			$('nav').show();
			IN.API.Profile("me")
			    .fields(["id", "firstName", "lastName"])
			    .result(function(result) {
			      addToDatabase(result.values[0]);
			    })
			    .error(function(err) {
			      alert(err);
			    });
			    $.sidr('close', 'sidr');

			function addToDatabase (profile) {
				
				window.userId = profile.id;
				var User = Parse.Object.extend("users");
				var query = new Parse.Query(User);
				query.equalTo("userId", profile.id);
				query.find({
					success: function(results) {
						if (results.length == 0){

							var User = Parse.Object.extend("users");
							var user = new User();

							user.set('userId', profile.id);
							user.set('fname', profile.firstName);
							user.set('lname', profile.lastName);
							user.set('status', 0);
							user.set('trueStatus', 2);

							user.save();
						}
						window.userObjectId = results[0].id;
						window.innerCircleList = results[0].get('innerCircle') || [];
						window.trueCircleList = results[0].get('trueCircle') || [];
						console.log(window.innerCircleList);
						//console.log(window.userObjectId);
						displayInnerCircle();	
					}
				})
			}

			IN.API.Connections("me")
				.fields("firstName", "lastName", "industry", "pictureUrl", "id")
				.result(displayConnections)
				.error(displayConnectionsErrors);
				document.getElementById('logout').addEventListener('click', logOut);

				
		}

		function logOut () {
			IN.User.logout();
			$("#container").load("login.html");
		}

		function displayNotifications() {
			//console.log(window.userObjectId);

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.get(window.userObjectId,{
				success: function(user){

					//console.log(user.get('notifications')[0]);
					for (var i = 0; i < user.get('notifications').length; i++){
						IN.API.Profile(user.get('notifications')[i]).result(populateNotifications);
						console.log('TEST');
					}
				},
			});
		}

		function populateNotifications(profiles){
			var member = profiles.values[0];

			var notificationsDiv = document.getElementById("notifications");
			notificationsDiv.innerHTML += '<p><a href="#" onclick="addToInnerCircle('+ "'" + member.id + "'" +')">Allow '+ member.firstName + ' ' + member.lastName +' to add you to their Inner Circle</a></p>';
		}

		function displayInnerCircle() {



			// var User = Parse.Object.extend("users");
			// var query = new Parse.Query(User);
			// query.get(window.userObjectId,{
			// 	success: function(user){
					console.log(window.innerCircleList);
					for (var i = 0; i < window.innerCircleList.length; i++){
						IN.API.Profile(window.innerCircleList[i]).result(populateInnerCircle);
					}
					
			// 	},
			// });
		}
		function populateInnerCircle(profiles){
			var member = profiles.values[0];
			var pictureUrl = member.pictureUrl || "images/anon.png";
			var innerCircleDiv = document.getElementById("innerCircle");

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.equalTo("userId", member.id);
			query.find({
				success: function (results) {
					var inTrueCircle = window.trueCircleList.indexOf(member.id);
					var theirTrueCircle = results[0].get('trueCircle') || [];
					// console.log(inTrueCircle);
					// console.log(member.id);
					// console.log(window.trueCircleList);
					// console.log(window.trueCircleList.indexOf(member.id));
					if (inTrueCircle >= 0){
						var memberStatus = results[0].get('trueStatus');
					} else {
						var memberStatus = results[0].get('status');
					}
					
					innerCircleDiv.innerHTML += "<div id='"+ member.id +"' class='innerConnection'><img src='"+ pictureUrl +"'><div class='innerConnectionInfo'><p class='innerName'>" + member.firstName + " " + member.lastName + "</p></div><img class='innerStatusIcon' src='" + window.iconsList[memberStatus] + "'><div class='innerButtons'><a href='#' onclick='sendMessage(" + '"' + member.id + '"' + ")'>Send a Message</a><a href='#' onclick='removeInner(" + '"' + member.id + '"' + ")'>Send to Business Class</a><a class='showTrue' href='#' onclick='showTrue(" + '"' + member.id + '"' + ")'>Show Status</a><a class='hideTrue' href='#' onclick='hideTrue(" + '"' + member.id + '"' + ")'>Hide Status</a></div></div>";

					if (theirTrueCircle.indexOf(window.userId) >=0){
						$('div#' + member.id + ' a.showTrue').hide();
					} else {
						$('div#' + member.id + ' a.hideTrue').hide();
					}


				}
			})

			
		}

		function removeInner (memberId) {

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.get(window.userObjectId,{
				success: function(user){
					console.log(memberId);
					user.remove('innerCircle', memberId);
					user.save();
					//onLinkedInAuth();
					$('#' + memberId).slideToggle();
					
				},
			});

		}

		function sendMessage (memberId) {

			$('body').append('<div id="blocker"><div id="messageBox"><h1>Send a Message</h1><textarea></textarea><div id="messageButtons"><a href="#" onclick="closeMessage()">Close</a><a href="#" onclick="closeMessage()">Send</a></div></div></div>');

		}

		function closeMessage () {
			$('#blocker').remove();
		}

		function addToInnerCircle(memberId) {
			console.log(memberId);

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.equalTo("userId", memberId);
			query.find({
				success: function (results){
					var object = results[0];
					var User = Parse.Object.extend("users");
					var query = new Parse.Query(User);
					query.get(object.id,{
						success: function(user){
							user.addUnique('innerCircle', window.userId);

							user.save();

							toNotifications();
						}
					});
			}
			});

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.get(window.userObjectId,{
				success: function(user){
					user.remove('notifications', memberId);

					user.save();
				}
			});
		}

		function toNotifications(){
			$("#container").load("notifications.html", function(){
				displayNotifications();
			});
			$.sidr('close', 'sidr');
		}
		function toStatus(){
			$("#container").load("status.html");
			$.sidr('close', 'sidr');
		}

		function displayConnections(connections) {

		  $("#container").load("connections.html", function(){
		  		var connectionsDiv = document.getElementById("connections");

		  var members = connections.values; // The list of members you are connected to
		  for (	 member in members) {
		  	if (members[member].firstName != 'private'){
		  		var contains = false;
		  		
		  		for (var i = 0; i < window.innerCircleList.length; i++){
		  			if (window.innerCircleList[i] === members[member].id){
		  				contains = true;
		  			}
		  		}
		  		if (contains == false){
		  			var memberStatus = '';
		  			
		  			var User = Parse.Object.extend("users");
					var query = new Parse.Query(User);
					query.equalTo("userId", members[member].id);
					query.find({
						success: function (results) {
							if (results.length > 0){
								memberStatus = results[0].get('bStatus');

							}
							
						}
					})	 

					var pictureUrl = members[member].pictureUrl || "images/anon.png";
		  			connectionsDiv.innerHTML += "<div id='"+ members[member].id +"' class='connection'><img src='" + pictureUrl + "'><div class='connectionInfo'><p class='connectionName'>" + members[member].firstName + " " + members[member].lastName
		     +"</p><p>" + memberStatus + "</p></div><a href='#' id='" + members[member].id + "' onclick='addToInner("+'"'+ members[member].id +'","'+members[member].firstName+'","'+members[member].lastName+'"'+ ")'>+</a></div>";
		  		}
		  	}
		  }

		  if (window.innerCircleList.length <= 0){
		  	document.getElementById('innerCircle').innerHTML += '<p class="noInnerList">You don&#146;t have anyone in your Inner Circle. Click on Business Class below to see you LinkedIn conncections and add some to your Inner Circle!</p>';
		  }   
		  });
		    
		}

		function displayConnectionsErrors(error) { /* do nothing */ }

		function addToInner (memberId,fname,lname){
			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.equalTo("userId", memberId);
			query.find({
				success: function(results) {
					if (results.length == 0){

						var User = Parse.Object.extend("users");
						var user = new User();

						user.set('userId', memberId);
						user.set('fname', fname);
						user.set('lname', lname);
						user.set('status', 0);
						user.set('trueStatus', 2);
						//user.addUnique('notifications', window.userId);

						user.save();
					}
					else if (results.length == 1){
						// var object = results[0];
						// var User = Parse.Object.extend("users");
						// var query = new Parse.Query(User);
						// query.get(object.id,{
						// 	success: function(user){
						// 		user.addUnique('notifications', window.userId);

						// 		user.save();
						// 	}
						// });
					}
					else{
						console.log('ERROR');
					}

					var User = Parse.Object.extend("users");
					var query = new Parse.Query(User);
					query.get(window.userObjectId,{
						success: function(user){
							console.log('ADDING USER')
							user.addUnique('innerCircle', memberId);

							user.save();
							console.log($('#' + memberId));
							$('#' + memberId).html('<p>Added to Inner Circle!</p>');

							setTimeout(function(){
								$('#' + memberId).slideToggle();
							}, 500);

						},
					});


				}
			})
			
		}

		function setStatus (status) {
			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.get(window.userObjectId,{
				success: function(user){
					user.set('status', status);

					user.save();
					if (status === 0){
						console.log('TEST STATUS');
						document.getElementById('looking').className = 'active';
						document.getElementById('interest').className = '';
						document.getElementById('happy').className = '';
					} else if (status === 1){
						console.log('TEST STATUS');
						document.getElementById('looking').className = '';
						document.getElementById('interest').className = 'active';
						document.getElementById('happy').className = '';

					} else if (status === 2){
						console.log('TEST STATUS');
						document.getElementById('looking').className = '';
						document.getElementById('interest').className = '';
						document.getElementById('happy').className = 'active';

					}
				},
			});
		}

		function contactsSwap(list) {
			if (list === 'inner'){

				onLinkedInAuth();

				// document.getElementById('inner').className = 'active';
				// document.getElementById('business').className = '';
				// document.getElementById('innerCircle').style.display = 'block';
				// document.getElementById('connections').style.display = 'none';
;
			}
			else if (list === 'business') {
				document.getElementById('business').className = 'active';
				document.getElementById('inner').className = '';
				document.getElementById('connections').style.display = 'block';
				document.getElementById('innerCircle').style.display ='none';
			}

		}

		function showTrue (memberId){

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.equalTo("userId", memberId);
			query.find({
				success: function(results) {
					
					var object = results[0];
					var User = Parse.Object.extend("users");
					var query = new Parse.Query(User);
					query.get(object.id,{
						success: function(user){
							console.log(user.id);

							user.addUnique('trueCircle', window.userId);

							user.save();

							$('div#' + memberId + ' a.showTrue').hide();
							$('div#' + memberId + ' a.hideTrue').show();
						}
					});

				}
			})

		}

		function hideTrue (memberId){

			var User = Parse.Object.extend("users");
			var query = new Parse.Query(User);
			query.equalTo("userId", memberId);
			query.find({
				success: function(results) {
					
					var object = results[0];
					var User = Parse.Object.extend("users");
					var query = new Parse.Query(User);
					query.get(object.id,{
						success: function(user){
							console.log(user.id);

							user.remove('trueCircle', window.userId);

							user.save();

							$('div#' + memberId+ ' a.hideTrue').hide();
							$('div#' + memberId + ' a.showTrue').show();

							console.log(user.id);
							
						}
					});

				}
			})

		}

	</script>
</body>